<project>

	<!-- This depends on the Hudson workspace structure. -->
	<property name="hudson-tools-archive-dir" location="../../hudson_tools/lastStable/archive" />
       
	<import file="${hudson-tools-archive-dir}/build-common.xml"/>

	<target name="build" depends="do-init-release, do-compile, do-test, project-jar, release-doc, do-checkstyle, do-findbugs, do-pmd, do-cpd" />


	<property name="lib-lucene"           location="ext/lucene-core-2.2.0.jar" />
	<property name="lib-osgi"             location="ext/org.osgi.core-1.2.0.jar" />
	<property name="lib-servlet"          location="ext/servlet-api-2.4.jar" />
	<property name="lib-slf4j"            location="ext/slf4j-api-1.5.0.jar" />

	<property name="classpath"            value="${lib-nds}:${lib-stachord}:${lib-junit}:${lib-tools}:${lib-mindterm}:${lib-lucene}:${lib-osgi}:${lib-servlet}:${lib-slf4j}" />

	<!-- Initialise release directory structure. -->
	<target name="do-init-release">
		<mkdir dir="bin" />
		<mkdir dir="doc" />
		<mkdir dir="junit" />
	</target>

	<!-- Compile current version. -->
	<target name="do-compile" depends="remove-class-files">
		<javac srcdir="src" destdir="bin" classpath="${classpath}">
			<compilerarg value="-Xlint:unchecked" />
		</javac>
	</target>
	
	<!-- Delete any existing .class files to force complete recompilation. -->
	<target name="remove-class-files">
		<delete failonerror="false">
			<fileset dir="./bin" includes="**/*.class"/>
		</delete>
	</target>

	<!-- Run check-in tests. -->
	<target name="do-test">
		<junit fork="yes" clonevm="true" maxmemory="256m" printsummary="no" showoutput="yes" failureproperty="test-failed" errorproperty="test-failed" filtertrace="no">
			<!-- Run tests with assertions enabled. -->
			<jvmarg value="-ea" />
			<formatter type="xml"/>
			<classpath path="bin:${classpath}"/>
			<test name="org.h2o.run.CheckInTests" todir="junit"/>
		</junit>
	</target>
	
	<!-- Generate project jar. -->
	<target name="project-jar">
		<jar destfile="bin/h2o.jar">
			<fileset dir="bin" includes="**/*.class" />
			<fileset dir="src/main" includes="**/*.java" />
		</jar>
	</target>

	<!-- Generate javadoc. -->
	<target name="release-doc">
		<javadoc
				classpath="${classpath}" sourcepath="src/main" destdir="doc" packagenames="org.h2o.*"
				access="public" linksource="yes" source="1.6" nodeprecated="false" nodeprecatedlist="false"
				noindex="false" nonavbar="false" notree="false" splitindex="false" use="false" author="true" version="true" verbose="true">

			<!-- Link to Java API from generated documentation. -->
			<link href="${doc-java}" />
		</javadoc>
	</target>
	

    <property name="checkstyle-check-dir" value="src/main/org/h2o" />
    <property name="pmd-check-dir" value="src/main/org/h2o" />

	<!-- Run bug scan. -->
	<target name="do-findbugs">
		<taskdef name="findbugs" classname="edu.umd.cs.findbugs.anttask.FindBugsTask">
			<classpath><pathelement location="${lib-findbugs}"/></classpath>
		</taskdef>
	    <findbugs home="${hudson-tools-lib-dir}" output="xml:withMessages" outputFile="findbugs.xml" excludeFilter="findbugs-exclude.xml">
	        <auxClasspath path="${classpath}" />
	        <sourcePath path="src/main/org/h2o" />
	        <class location="bin/org/h2o" />
	    </findbugs>
    </target>
	
	<!-- Run duplicate code check. -->
	<target name="do-cpd">
	    <taskdef name="cpd" classname="net.sourceforge.pmd.cpd.CPDTask">
			<classpath><pathelement location="${lib-pmd}"/></classpath>
		</taskdef>
	    <cpd minimumTokenCount="100" format="xml" outputFile="cpd.xml">
	        <fileset dir="src/main/org/h2o">
	            <include name="**/*.java"/>
	        </fileset>
	    </cpd>
	</target>


</project>
